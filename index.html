<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gu√≠a Interactiva: Plantilla de Rifa en Excel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&family=Fira+Code:wght@400;600&display=swap"
        rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #1F1F1F;
            color: #ffffff;
        }

        .excel-cell {
            transition: all 0.2s;
            cursor: pointer;
        }

        .excel-cell:hover {
            transform: scale(1.05);
            border-color: #FFD700;
        }

        .formula-font {
            font-family: 'Fira Code', monospace;
        }

        .chart-container {
            position: relative;
            width: 100%;
            max-width: 500px;
            height: 300px;
            margin: 0 auto;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #374151;
            border-radius: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background-color: #1F2937;
        }
    </style>
</head>

<body class="min-h-screen flex flex-col">

    <!-- Navbar -->
    <nav class="bg-[#006400] text-white p-4 shadow-lg border-b border-gray-600">
        <div class="container mx-auto flex justify-between items-center flex-wrap">
            <div class="flex items-center space-x-4">
                <span class="text-2xl font-bold">üìä LA MEGA RIFA</span>
            </div>
            <div class="text-sm opacity-80 mt-2 sm:mt-0">
                Ganate esta espectacular rifa
            </div>
        </div>
    </nav>

    <!-- Header -->
    <header class="py-10 text-center border-b border-gray-700 bg-[#121212]">
        <div class="container mx-auto px-4">
            <h1 class="text-4xl md:text-6xl font-bold text-[#FFD700] mb-2 tracking-wider drop-shadow-md">
                LA MEGA RIFA
            </h1>

            <div class="flex justify-center items-center gap-8 md:gap-16 my-6">
                <!-- Imagen Izquierda -->
                <div class="relative group">
                    <div
                        class="absolute -inset-1 bg-gradient-to-r from-yellow-400 to-orange-500 rounded-full blur opacity-25 group-hover:opacity-75 transition duration-1000 group-hover:duration-200">
                    </div>
                    <img src="img/trophy.png" alt="Trofeo"
                        class="relative w-24 md:w-32 transform rotate-[-10deg] hover:rotate-0 transition duration-300 drop-shadow-2xl">
                </div>

                <!-- Imagen Derecha -->
                <div class="relative group">
                    <div
                        class="absolute -inset-1 bg-gradient-to-r from-blue-400 to-purple-500 rounded-full blur opacity-25 group-hover:opacity-75 transition duration-1000 group-hover:duration-200">
                    </div>
                    <img src="img/tickets.png" alt="Boletos"
                        class="relative w-24 md:w-32 transform rotate-[10deg] hover:rotate-0 transition duration-300 drop-shadow-2xl">
                </div>
            </div>

            <h2 class="text-xl md:text-3xl font-bold text-white tracking-wide">
                Proyecto: Gana el "Turbo Sonido X-9000"
                
            </h2>
            <h2 class="text-xl md:text-3xl font-bold text-white tracking-wide">
                valor del premio: $5000
                
            </h2>

        </div>
    </header>

    <main class="flex-grow container mx-auto px-4 py-8 space-y-12">

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">

            <!-- LEFT COLUMN: GRID -->
            <div class="lg:col-span-7 space-y-6">
                <div class="bg-gray-800 p-6 rounded-lg shadow-xl border border-gray-700">
                    <h3 class="text-2xl font-bold text-[#FFD700] mb-2">1. La Cuadr√≠cula (1-100)</h3>
                    <p class="text-gray-300 text-sm mb-4">
                        Haz clic en cualquier n√∫mero para asignarlo.
                    </p>

                    <div id="raffleGrid" class="grid grid-cols-10 gap-1 sm:gap-2"></div>

                    <div class="mt-6 bg-gray-900 p-4 rounded border-l-4 border-[#00B050]">
                        <h4 class="text-[#00B050] font-bold mb-1">üß† Formula de Excel:</h4>
                        <code class="formula-font bg-black text-yellow-300 p-2 block rounded text-sm overflow-x-auto">
                            =CONTAR.SI($L:$L; A10)>0
                        </code>
                    </div>
                </div>
            </div>

            <!-- RIGHT COLUMN: LIST + STATS -->
            <div class="lg:col-span-5 space-y-6">

                <!-- LIST -->
                <div class="bg-gray-800 p-6 rounded-lg shadow-xl border border-gray-700">
                    <h3 class="text-xl font-bold text-white mb-2">2.LISTA  DE CONCURSANTES</h3>

                    <div class="grid grid-cols-3 gap-1 mb-2 font-bold text-xs text-center">
                        <div class="bg-[#003366] text-white p-2 rounded-tl">N√öMERO</div>
                        <div class="bg-[#003366] text-white p-2">NOMBRE</div>
                        <div class="bg-[#003366] text-white p-2 rounded-tr">ADMIN</div>
                    </div>

                    <div id="participantsList"
                        class="h-48 overflow-y-auto bg-gray-900 border border-gray-600 rounded-b p-2 custom-scrollbar">
                        <div class="text-gray-500 text-center text-sm italic py-4">
                            A√∫n no hay n√∫meros asignados.
                        </div>
                    </div>

                    <div class="mt-4 flex justify-end">
                        <button onclick="resetRaffle()"
                            class="px-4 py-2 bg-red-800 hover:bg-red-700 text-white text-sm font-bold rounded">
                            Reiniciar Sorteo
                        </button>
                    </div>
                </div>

                <!-- STATS -->
                <div class="bg-gray-800 p-6 rounded-lg shadow-xl border border-gray-700">
                    <h3 class="text-xl font-bold text-white mb-2">3. Estad√≠sticas en Tiempo Real</h3>

                    <div class="chart-container">
                        <canvas id="statsChart"></canvas>
                    </div>

                    <div class="grid grid-cols-3 gap-2 mt-4 text-center">
                        <div class="bg-black p-2 rounded border border-gray-600">
                            <div class="text-xs text-gray-400">TOTAL</div>
                            <div class="text-xl font-bold text-white">100</div>
                        </div>
                        <div class="bg-[#006400] p-2 rounded border border-gray-600">
                            <div class="text-xs text-gray-200">ASIGNADOS</div>
                            <div id="statSold" class="text-xl font-bold text-[#FFD700]">0</div>
                        </div>
                        <div class="bg-[#8B0000] p-2 rounded border border-gray-600">
                            <div class="text-xs text-gray-200">DISPONIBLES</div>
                            <div id="statAvail" class="text-xl font-bold text-[#FFD700]">100</div>
                        </div>
                    </div>
                </div>

            </div>
        </div>

    </main>

    <!-- FOOTER -->
    <footer class="bg-black text-center py-6 text-gray-500 text-sm">
        <p>&copy; 2025 Generador de Rifa Profesional.</p>
    </footer>

    <!-- JAVASCRIPT LOGIC -->
    <script>

        /* ============================
           CONFIG
        ============================ */

        const API_URL = "https://script.google.com/macros/s/AKfycbzMY9oC0MoYHd2DP5_mtjwWnJiQLAMETqF98vHnj25n4OelV6mTw_QrO6rQfllKuI9l/exec";

        const TOTAL_TICKETS = 100;
        let assignedTickets = new Map();
        let chartInstance = null;

        const ADMIN_CODE_ENCODED = "U2hheWRhMTkwNA==";
        function decodeBase64(s) { try { return atob(s); } catch { return ""; } }
        function getAdminCode() { return decodeBase64(ADMIN_CODE_ENCODED); }

        /* ============================
           INIT
        ============================ */

        document.addEventListener("DOMContentLoaded", () => {
            initGrid();
            initChart();
            loadInitialData();
            updateStatsUI();
        });

        async function loadInitialData() {
            try {
                const res = await fetch(API_URL);
                const json = await res.json();
                if (json.status === "ok") {
                    assignedTickets.clear();
                    json.data.forEach(item => {
                        if (item.numero) {
                            assignedTickets.set(Number(item.numero), item.nombre);
                        }
                    });
                    renderGridState();
                    renderParticipantsList();
                    updateStatsUI();
                    updateChart();
                }
            } catch (e) {
                console.error("Error loading initial data:", e);
            }
        }

        /* ============================
           GRID
        ============================ */

        function initGrid() {
            const grid = document.getElementById("raffleGrid");
            for (let i = 1; i <= TOTAL_TICKETS; i++) {
                let c = document.createElement("div");
                c.id = "ticket-" + i;
                c.textContent = i;
                c.className = "excel-cell h-10 sm:h-12 flex items-center justify-center border border-gray-600 text-sm sm:text-lg font-bold rounded bg-gray-700";
                c.onclick = () => toggleTicket(i);
                grid.appendChild(c);
            }
        }

        async function toggleTicket(number) {
            if (assignedTickets.has(number)) {
                alert("Ese n√∫mero ya est√° asignado.");
                return;
            }

            const buyerName = prompt("Nombre para el n√∫mero " + number + ":");
            if (!buyerName) return;

            assignedTickets.set(number, buyerName.trim());
            renderGridState();
            renderParticipantsList();
            updateStatsUI();
            updateChart();

            try {
                await fetch(API_URL, {
                    method: "POST",
                    body: JSON.stringify({
                        action: "save",
                        clave: getAdminCode(),
                        nombre: buyerName.trim(),
                        numero: number
                    }),
                    headers: { "Content-Type": "text/plain;charset=utf-8" }
                });
            } catch (e) {
                console.error(e);
                alert("No se pudo guardar en Google Sheets");
            }
        }

        /* ============================
           DELETE
        ============================ */

        async function deleteTicket(number) {
            const owner = assignedTickets.get(number);
            if (!confirm("¬øEliminar " + number + " de " + owner + "?")) return;

            let code = prompt("C√≥digo admin:");
            if (code === null) return;
            code = code.trim();

            try {
                const res = await fetch(API_URL, {
                    method: "POST",
                    body: JSON.stringify({
                        action: "delete",
                        clave: code,
                        numero: number
                    }),
                    headers: { "Content-Type": "text/plain;charset=utf-8" }
                });
                const j = await res.json();

                if (j.status === "ok") {
                    assignedTickets.delete(number);
                    renderGridState();
                    renderParticipantsList();
                    updateStatsUI();
                    updateChart();
                    alert("Eliminado");
                } else {
                    alert(j.message);
                }

            } catch (e) {
                alert("Error eliminando");
            }
        }

        /* ============================
           RENDERERS
        ============================ */

        function renderGridState() {
            for (let i = 1; i <= TOTAL_TICKETS; i++) {
                const c = document.getElementById("ticket-" + i);
                if (assignedTickets.has(i)) {
                    c.classList.remove("bg-gray-700");
                    c.classList.add("bg-[#00B050]", "border-[#FFD700]");
                } else {
                    c.classList.remove("bg-[#00B050]", "border-[#FFD700]");
                    c.classList.add("bg-gray-700");
                }
            }
        }

        function renderParticipantsList() {
            const div = document.getElementById("participantsList");
            if (assignedTickets.size === 0) {
                div.innerHTML = "<div class='text-gray-500 text-center py-4'>No hay asignados.</div>";
                return;
            }

            let html = "<div>";
            [...assignedTickets.keys()].sort((a, b) => a - b).forEach(num => {
                html += `
                    <div class="grid grid-cols-3 gap-1 text-sm border-b border-gray-700 pb-1 items-center">
                        <div class="text-center font-bold text-[#FFD700]">${num}</div>
                        <div class="text-gray-300 pl-2">${assignedTickets.get(num)}</div>
                        <button onclick="deleteTicket(${num})" class="text-red-500 hover:text-red-700 text-xs font-bold">üóëÔ∏è</button>
                    </div>`;
            });
            html += "</div>";
            div.innerHTML = html;
        }

        /* ============================
           RESET
        ============================ */

        async function resetRaffle() {
            if (!confirm("¬øReiniciar sorteo completo?")) return;
            let code = prompt("C√≥digo admin:");
            if (code === null) return;
            code = code.trim();

            for (let n of assignedTickets.keys()) {
                await fetch(API_URL, {
                    method: "POST",
                    body: JSON.stringify({ action: "delete", clave: code, numero: n }),
                    headers: { "Content-Type": "text/plain;charset=utf-8" }
                });
            }

            assignedTickets.clear();
            renderGridState();
            renderParticipantsList();
            updateStatsUI();
            updateChart();
            alert("Sorteo reiniciado.");
        }

        /* ============================
           CHART
        ============================ */

        function initChart() {
            const ctx = document.getElementById("statsChart");
            chartInstance = new Chart(ctx, {
                type: "doughnut",
                data: {
                    labels: ["Asignados", "Disponibles"],
                    datasets: [{
                        data: [0, 100],
                        backgroundColor: ["#00B050", "#8B0000"],
                        borderColor: "#1F1F1F",
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { labels: { color: "white" } }
                    }
                }
            });
        }

        function updateChart() {
            chartInstance.data.datasets[0].data = [
                assignedTickets.size,
                TOTAL_TICKETS - assignedTickets.size
            ];
            chartInstance.update();
        }

        function updateStatsUI() {
            document.getElementById("statSold").textContent = assignedTickets.size;
            document.getElementById("statAvail").textContent = TOTAL_TICKETS - assignedTickets.size;
        }

    </script>

</body>

</html>